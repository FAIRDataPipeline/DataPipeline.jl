<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Simple example · [SCRC] DataRegistryUtils.jl docs</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="[SCRC] DataRegistryUtils.jl docs logo"/></a><div class="docs-package-name"><span class="docs-autofit">[SCRC] DataRegistryUtils.jl docs</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li class="is-active"><a class="tocitem" href>Simple example</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#.-Package-installation"><span>0. Package installation</span></a></li><li><a class="tocitem" href="#.-Preliminaries:-import-packages"><span>1. Preliminaries: import packages</span></a></li><li><a class="tocitem" href="#.-Specify-config-files,-scripts-and-data-directory"><span>2. Specify config files, scripts and data directory</span></a></li><li><a class="tocitem" href="#.-Downloading-data-products"><span>3. Downloading data products</span></a></li><li><a class="tocitem" href="#.-Model-simulation"><span>4. Model simulation</span></a></li><li><a class="tocitem" href="#.-Registering-model-code"><span>3. Registering model code</span></a></li><li><a class="tocitem" href="#.-Registering-a-&#39;model-run&#39;"><span>6. Registering a &#39;model run&#39;</span></a></li><li><a class="tocitem" href="#.-Finally,-commit-objects-to-registry"><span>7. Finally, commit objects to registry</span></a></li><li><a class="tocitem" href="#Finished!"><span>Finished!</span></a></li></ul></li><li><a class="tocitem" href="../manual/">Package manual</a></li><li><a class="tocitem" href="../snip/">Code snippets</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Simple example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Simple example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ScottishCovidResponse/DataRegistryUtils.jl/blob/master/docs/src/examples.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Simple-example"><a class="docs-heading-anchor" href="#Simple-example">Simple example</a><a id="Simple-example-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-example" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>The purpose of this tutorial is to demonstrate use of the package to interact with the SCRC Data Registry (DR) in a process referred to as the &#39;pipeline&#39;, including:</p><ul><li>How to read data products from the DR,</li><li>utilise them in a simple simulation model,</li><li>register the simulation model code with the DR,</li><li>and register the simulation model run with the DR.</li></ul><p>The example is also provided as working code (including the accompanying configuration files) in the <em>examples/simple</em> directory of the package repository. The steps and the corresponding line of code in that module are:</p><table><tr><th style="text-align: center">Steps / Learning outcomes</th><th style="text-align: center">Code</th></tr><tr><td style="text-align: center">1. Preliminaries</td><td style="text-align: center">L24</td></tr><tr><td style="text-align: center">2. Config files and scripts</td><td style="text-align: center">L32</td></tr><tr><td style="text-align: center">3. Reading data products from the Registry</td><td style="text-align: center">L43</td></tr><tr><td style="text-align: center">4. Running a model simulation</td><td style="text-align: center">L65</td></tr><tr><td style="text-align: center">4b. Automatic data access logging</td><td style="text-align: center">L103</td></tr><tr><td style="text-align: center">5. Staging &#39;code repo releases&#39; (i.e. model code)</td><td style="text-align: center">L107</td></tr><tr><td style="text-align: center">6. Staging model &#39;code runs&#39;</td><td style="text-align: center">L111</td></tr><tr><td style="text-align: center">7. Committing staged objects to the Registry</td><td style="text-align: center">L133</td></tr></table><h2 id=".-Package-installation"><a class="docs-heading-anchor" href="#.-Package-installation">0. Package installation</a><a id=".-Package-installation-1"></a><a class="docs-heading-anchor-permalink" href="#.-Package-installation" title="Permalink"></a></h2><p>The package is not currently registered and must be added via the package manager Pkg. From the REPL type <code>]</code> to enter Pkg mode and run:</p><pre><code class="language-none">pkg&gt; add https://github.com/ScottishCovidResponse/DataRegistryUtils.jl</code></pre><h2 id=".-Preliminaries:-import-packages"><a class="docs-heading-anchor" href="#.-Preliminaries:-import-packages">1. Preliminaries: import packages</a><a id=".-Preliminaries:-import-packages-1"></a><a class="docs-heading-anchor-permalink" href="#.-Preliminaries:-import-packages" title="Permalink"></a></h2><pre><code class="language-julia">import DataRegistryUtils    # pipeline stuff
import DPOMPs               # simulation of epidemiological models
import YAML                 # for reading model config file
import Random               # other assorted packages used incidentally
import DataFrames</code></pre><h2 id=".-Specify-config-files,-scripts-and-data-directory"><a class="docs-heading-anchor" href="#.-Specify-config-files,-scripts-and-data-directory">2. Specify config files, scripts and data directory</a><a id=".-Specify-config-files,-scripts-and-data-directory-1"></a><a class="docs-heading-anchor-permalink" href="#.-Specify-config-files,-scripts-and-data-directory" title="Permalink"></a></h2><p>These variables and the corresponding files determine the model configuration; data products to be downloaded; and &#39;submission script&#39; (see 2c.)</p><pre><code class="language-julia">model_config = &quot;/examples/simple/model_config.yaml&quot;     # (see 2a)
data_config = &quot;/examples/simple/data_config.yaml&quot;       # (see 2b)
submission_script = &quot;julia examples/simple/main.jl&quot;     # (see 2c)</code></pre><h3 id="a.-The-*model_config.yaml*-file"><a class="docs-heading-anchor" href="#a.-The-*model_config.yaml*-file">2a. The <em>model_config.yaml</em> file</a><a id="a.-The-*model_config.yaml*-file-1"></a><a class="docs-heading-anchor-permalink" href="#a.-The-*model_config.yaml*-file" title="Permalink"></a></h3><p>The <strong>&#39;model config&#39;</strong> file concept is used throughout the SCRC data pipeline, (i.e. not just within this package.) In this example, it is used to store information about both the model code (step 3,) and the individual code run (step 6.) The example below is also given <a href="&quot;https:/raw.githubusercontent.com/ScottishCovidResponse/DataRegistryUtils.jl/main/examples/simple/data_config.yaml&quot;">here</a>.</p><pre><code class="language-yaml"># model
model_name: &quot;DRU simple example&quot;
model_repo: &quot;https://github.com/ScottishCovidResponse/DataRegistryUtils.jl&quot;
# NB. ^ because the example is part of this package - replace with your own repo
model_version: &quot;0.0.4&quot;
model_description: &quot;A simple SEIR simulation for demonstrating use of the DataRegistryUtils.jl package.&quot;
model_website: &quot;https://mjb3.github.io/DiscretePOMP.jl/stable/&quot;

# simulation parameters
random_seed: 1
initial_s: 1000   # initial population size
max_t: 180.0      # simulation time
beta: 0.7         # contact rate := beta SI / N</code></pre><h3 id="b.-The-*data_config.yaml*-file"><a class="docs-heading-anchor" href="#b.-The-*data_config.yaml*-file">2b. The <em>data_config.yaml</em> file</a><a id="b.-The-*data_config.yaml*-file-1"></a><a class="docs-heading-anchor-permalink" href="#b.-The-*data_config.yaml*-file" title="Permalink"></a></h3><p>Similar to the model configuration file, <strong>&#39;data config&#39;</strong> files are a standard way to interact with the data pipeline, including in other languages besides <code>Julia</code>. This example specifies the Data Products that are downloaded in step 4:</p><pre><code class="language-yaml">fail_on_hash_mismatch: True     # set &#39;False&#39; to suppress data mismatch errors
namespace: SCRC                 # default namespace

read:
  - where:
      data_product: human/infection/SARS-CoV-2/symptom-probability
      component: symptom-probability
  - where:
      data_product: prob_hosp_and_cfr/data_for_scotland
      component: cfr_byage
    use:
      namespace: EERA
  - where:
      data_product: human/infection/SARS-CoV-2/asymptomatic-period
      component: asymptomatic-period
  - where:
      data_product: human/infection/SARS-CoV-2/infectious-duration
      component: infectious-duration
  - where:
      data_product: human/infection/SARS-CoV-2/latent-period
      component: latent-period
  - where:
      data_product: fixed-parameters/T_hos
      component: T_hos
    use:
      namespace: EERA
  - where:
      data_product: fixed-parameters/T_rec
      component: T_rec
    use:
      namespace: EERA</code></pre><h3 id="c.-The-*submission_script*-variable"><a class="docs-heading-anchor" href="#c.-The-*submission_script*-variable">2c. The <em>submission_script</em> variable</a><a id="c.-The-*submission_script*-variable-1"></a><a class="docs-heading-anchor-permalink" href="#c.-The-*submission_script*-variable" title="Permalink"></a></h3><p>Finally, the <code>submission_script</code> variable is a string that contains the contents of the &#39;submission script&#39; file; another artefact of the pipeline process that applies outwith the Julia package.</p><pre><code class="language-julia">submission_script = &quot;julia examples/simple/main.jl&quot;</code></pre><p>Here it is used to define the &#39;entry point&#39; of the application; together with the model code and &#39;config&#39; files, it will allow others to reproduce our results in the future with ease and precision (an important benefit of the overall pipeline process.)</p><h2 id=".-Downloading-data-products"><a class="docs-heading-anchor" href="#.-Downloading-data-products">3. Downloading data products</a><a id=".-Downloading-data-products-1"></a><a class="docs-heading-anchor-permalink" href="#.-Downloading-data-products" title="Permalink"></a></h2><p>Here we read some epidemiological parameters from the DR, so we can use them to run an <strong>SEIR</strong> simulation in <strong>step (5)</strong>. First we download some data, then read it.</p><h3 id="a.-Download-data"><a class="docs-heading-anchor" href="#a.-Download-data">3a. Download data</a><a id="a.-Download-data-1"></a><a class="docs-heading-anchor-permalink" href="#a.-Download-data" title="Permalink"></a></h3><p>First, we process the <code>data_config</code> file, which (in this case) returns a variable representing a connection to a SQLite database. I.e. we download the data products:</p><pre><code class="language-julia">data_dir = &quot;/examples/simple/data/&quot; # local directory where data is to be stored
db = DataRegistryUtils.initialise_local_registry(data_dir, data_config=data_config)</code></pre><h3 id="b.-Read-some-data"><a class="docs-heading-anchor" href="#b.-Read-some-data">3b. Read some data</a><a id="b.-Read-some-data-1"></a><a class="docs-heading-anchor-permalink" href="#b.-Read-some-data" title="Permalink"></a></h3><p>Next, we read some parameters and convert them to the required units.</p><pre><code class="language-julia">inf_period_days = DataRegistryUtils.read_estimate(db, &quot;human/infection/SARS-CoV-2/%&quot;, &quot;infectious-duration&quot;, key=&quot;value&quot;, data_type=Float64)[1] / 24
lat_period_days = DataRegistryUtils.read_estimate(db, &quot;human/infection/SARS-CoV-2/%&quot;, &quot;latent-period&quot;, key=&quot;value&quot;, data_type=Float64)[1] / 24</code></pre><p>See <a href="../snip/#Code-snippets">Code snippets</a> and the <a href="../manual/#Package-manual">Package manual</a> for information about reading other types of data product.</p><h3 id="c.-Offline-access"><a class="docs-heading-anchor" href="#c.-Offline-access">3c. Offline access</a><a id="c.-Offline-access-1"></a><a class="docs-heading-anchor-permalink" href="#c.-Offline-access" title="Permalink"></a></h3><p>Once the data has been downloaded initially, it can be retrieved for offline access (e.g. no or slow internet connections) using the <code>offline_mode</code> option:</p><pre><code class="language-julia">db = DataRegistryUtils.initialise_local_registry(data_dir, data_config=data_config, auto_logging=true, offline_mode=true)</code></pre><p>The main functions for registering objects, such as model code, model runs, and data products, work by staging the data to a local database so they are also compatible with &#39;offline mode&#39;. only the <code>commit_</code> functions require internet access, which can be run once access has been restored.</p><h2 id=".-Model-simulation"><a class="docs-heading-anchor" href="#.-Model-simulation">4. Model simulation</a><a id=".-Model-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#.-Model-simulation" title="Permalink"></a></h2><p><strong>Step 5 relies on the use of another package: <a href="https://github.com/mjb3/DiscretePOMP.jl">DiscretePOMP.jl</a>, so you may wish to skip this section or replace it with, e.g. your own model or simulation code.</strong></p><p>Next, <em>for illustration purposes only</em> we run a simple <strong>SEIR</strong> simulation using the Gillespie simulation feature of the <code>DiscretePOMP.jl</code> package. We use the downloaded parameters* as inputs, and finally plot the results as a time series of the population as they migrate between states according to the stochastic dynamics of the model.</p><p>First we extract some information about the model run from the <code>model_config.yaml</code> file:</p><pre><code class="language-julia">mc = YAML.load_file(model_config)
p = mc[&quot;initial_s&quot;]   # population size
t = mc[&quot;max_t&quot;]       # simulation time
beta = mc[&quot;beta&quot;]     # nb. contact rate := beta SI / N
Random.seed!(mc[&quot;random_seed&quot;])</code></pre><p>These include the population size and contact parameter beta, as well as the random seed. We are then ready the generate a DiscretePOMP model:</p><pre><code class="language-julia">## define a vector of simulation parameters
theta = [beta, inf_period_days^-1, lat_period_days^-1]
## initial system state variable [S E I R]
initial_condition = [p - 1, 0, 1, 0]
## generate DPOMPs model (see https://github.com/mjb3/DiscretePOMP.jl)
model = DiscretePOMP.generate_model(&quot;SEIR&quot;, initial_condition, freq_dep=true)</code></pre><p>Finally, we run the simulation and plot the results:</p><pre><code class="language-julia">x = DiscretePOMP.gillespie_sim(model, theta, tmax=t)
println(DiscretePOMP.plot_trajectory(x))</code></pre><h3 id="b.-automatic-data-access-logging"><a class="docs-heading-anchor" href="#b.-automatic-data-access-logging">4b. automatic data access logging</a><a id="b.-automatic-data-access-logging-1"></a><a class="docs-heading-anchor-permalink" href="#b.-automatic-data-access-logging" title="Permalink"></a></h3><p>In order to register a given code run in the DR, we require a record of the data products and components accessed to produce that particular run. Data access logging can essentially be handled automatically. The most recent active data log is used to register code runs by default. However, it is advisable to manually &#39;finish&#39; the log instead, and specify the log id manually at the point of registration:</p><pre><code class="language-julia">## this is not usually necessary in a single process environment:
# initialise_data_log(db, offline_mode)

## this is necessary when we want a [human-*and*-machine-readable] file copy of the log
log_id = DataRegistryUtils.finish_data_log(db; filepath=data_log)</code></pre><p>This is particularly important if we are planning on doing further work in the interim, such as if we want an accurate record of the access <em>time</em>. Logs should also handled manually (including initialisation) when working with multiple processes running on separate cores, but utilising the same filesystem/data resources.</p><h2 id=".-Registering-model-code"><a class="docs-heading-anchor" href="#.-Registering-model-code">3. Registering model code</a><a id=".-Registering-model-code-1"></a><a class="docs-heading-anchor-permalink" href="#.-Registering-model-code" title="Permalink"></a></h2><h3 id="a.-SCRC-access-token-request-via-https://data.scrc.uk/docs/"><a class="docs-heading-anchor" href="#a.-SCRC-access-token-request-via-https://data.scrc.uk/docs/">3a. SCRC access token - request via https://data.scrc.uk/docs/</a><a id="a.-SCRC-access-token-request-via-https://data.scrc.uk/docs/-1"></a><a class="docs-heading-anchor-permalink" href="#a.-SCRC-access-token-request-via-https://data.scrc.uk/docs/" title="Permalink"></a></h3><p>An access token is required if you want to <em>write</em> to the DR (e.g. register model code / runs) but not necessary if you only want to <em>read</em> from the DR (e.g. download data products.)</p><p>The token must not be shared. Common approaches include the use of system variables or [private] configuration files. In this example I have included mine as a separate Julia file with a single line of code. <em>Note that it is important to also specify the .gitignore so as not to accidentally upload to the internet!</em></p><pre><code class="language-julia">include(&quot;access-token.jl&quot;)</code></pre><p>The variable itself looks like: <code>&quot;token [my token]&quot;</code>. For example, if the token is the numbers one through six, the access-token.jl file looks like this:</p><pre><code class="language-julia">const scrc_access_tkn = &quot;token 123456&quot;</code></pre><h3 id="b.-Register-model-code"><a class="docs-heading-anchor" href="#b.-Register-model-code">3b. Register model code</a><a id="b.-Register-model-code-1"></a><a class="docs-heading-anchor-permalink" href="#b.-Register-model-code" title="Permalink"></a></h3><p>Back in the main file, we handle model code [release] registration by calling a function that automatically returns the existing <code>code_repo_release</code> URI if it is already registered, or a new one if not.</p><pre><code class="language-julia">code_release_id = DataRegistryUtils.register_github_model(model_config, scrc_access_tkn)</code></pre><p>Here we have used a .yaml configuration file but for illustration, the code is roughly equivalent to this:</p><pre><code class="language-julia">model_name = &quot;DRU simple example&quot;
model_repo = &quot;https://github.com/ScottishCovidResponse/DataRegistryUtils.jl&quot;
model_version = &quot;0.0.1&quot;
model_description = &quot; ... &quot; (nb. insert description)
model_docs = &quot;https://mjb3.github.io/DiscretePOMP.jl/stable/&quot;
code_release_id = DataRegistryUtils.register_github_model(model_name, model_version, model_repo, model_hash, scrc_access_tkn, model_description=model_description, model_website=model_docs)</code></pre><p>Finally, the resulting URI is in the form:</p><pre><code class="language-julia">code_release_id := &quot;https://data.scrc.uk/api/code_repo_release/2157/&quot;</code></pre><h2 id=".-Registering-a-&#39;model-run&#39;"><a class="docs-heading-anchor" href="#.-Registering-a-&#39;model-run&#39;">6. Registering a &#39;model run&#39;</a><a id=".-Registering-a-&#39;model-run&#39;-1"></a><a class="docs-heading-anchor-permalink" href="#.-Registering-a-&#39;model-run&#39;" title="Permalink"></a></h2><p>Next we register the results of this particular simulation by POSTing to the <code>code_run</code> endpoint of the DR&#39;s RESTful API:</p><pre><code class="language-julia">model_run_description = &quot;Just another SEIR simulation.&quot;
model_run_id = DataRegistryUtils.register_model_run(model_config, submission_script, code_release_id, model_run_description, scrc_access_tkn)</code></pre><h2 id=".-Finally,-commit-objects-to-registry"><a class="docs-heading-anchor" href="#.-Finally,-commit-objects-to-registry">7. Finally, commit objects to registry</a><a id=".-Finally,-commit-objects-to-registry-1"></a><a class="docs-heading-anchor-permalink" href="#.-Finally,-commit-objects-to-registry" title="Permalink"></a></h2><p>The final step is to commit the local changes we have made to the DR:</p><pre><code class="language-julia">code_release_url = DataRegistryUtils.commit_staged_model(db, code_release_id, scrc_access_tkn)
model_run_url = DataRegistryUtils.commit_staged_run(db, model_run_id, scrc_access_tkn)
DataRegistryUtils.registry_commit_status(db)    # optional: display status</code></pre><h2 id="Finished!"><a class="docs-heading-anchor" href="#Finished!">Finished!</a><a id="Finished!-1"></a><a class="docs-heading-anchor-permalink" href="#Finished!" title="Permalink"></a></h2><p>That concludes the example. A complete working example of this code can be found <a href="https://github.com/ScottishCovidResponse/DataRegistryUtils.jl/tree/main/examples/simple">here</a>.</p><p>Please note that certain features, notably the registration of Data Products (i.e. model &#39;inputs&#39; and &#39;outputs&#39;) is currently still a work in progress. See the home page for more information.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Introduction</a><a class="docs-footer-nextpage" href="../manual/">Package manual »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 22 February 2021 15:59">Monday 22 February 2021</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
